<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理 - CMDB系统</title>
    <link href="https://cdn.jsdelivr.net/npm/element-plus@2.4.0/dist/index.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus@2.4.0/dist/index.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="auth.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f7fa;
            min-height: 100vh;
        }
        .header {
            background-color: #1989fa;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }
        .header-title {
            font-size: 20px;
            font-weight: 600;
        }
        .user-info {
            display: flex;
            align-items: center;
        }
        .user-name {
            margin-right: 15px;
        }
        .logout-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .page-header {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .page-title {
            font-size: 18px;
            font-weight: 600;
            color: #303133;
        }
        .search-area {
            display: flex;
            gap: 10px;
        }
        .user-table {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .permission-edit {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f5f7fa;
            border-radius: 4px;
        }
        .dialog-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 顶部导航 -->
        <div class="header">
            <div class="header-title">CMDB资产管理系统</div>
            <div class="user-info">
                <span class="user-name">欢迎, {{ currentUser?.username }}</span>
                <button class="logout-btn" @click="handleLogout">退出登录</button>
            </div>
        </div>
        
        <!-- 主要内容区域 -->
        <div class="container">
            <!-- 页面头部 -->
            <div class="page-header">
                <div class="page-title">用户管理</div>
                <div class="search-area">
                    <el-input v-model="searchQuery" placeholder="搜索用户名" style="width: 200px;"></el-input>
                    <el-button type="primary" @click="handleSearch">搜索</el-button>
                </div>
            </div>
            
            <!-- 用户表格 -->
            <div class="user-table">
                <el-table :data="filteredUsers" style="width: 100%">
                    <el-table-column prop="id" label="用户ID" width="80"></el-table-column>
                    <el-table-column prop="username" label="用户名" width="120"></el-table-column>
                    <el-table-column prop="email" label="邮箱" width="200"></el-table-column>
                    <el-table-column prop="role" label="角色" width="100">
                        <template #default="scope">
                            <el-tag :type="scope.row.role === 'admin' ? 'primary' : 'success'">
                                {{ scope.row.role === 'admin' ? '管理员' : '普通用户' }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="is_active" label="状态" width="100">
                        <template #default="scope">
                            <el-switch 
                                v-model="scope.row.is_active" 
                                :active-color="'#13ce66'" 
                                :inactive-color="'#dcdfe6'"
                                @change="updateUserStatus(scope.row)"
                            ></el-switch>
                        </template>
                    </el-table-column>
                    <el-table-column label="权限" width="200">
                        <template #default="scope">
                            <el-tag 
                                v-for="permission in scope.row.permissions" 
                                :key="permission" 
                                size="small" 
                                style="margin-right: 5px; margin-bottom: 5px;"
                            >
                                {{ permission }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column label="操作" width="150">
                        <template #default="scope">
                            <el-button 
                                type="primary" 
                                size="small" 
                                @click="editUserPermissions(scope.row)"
                                data-admin-only
                            >
                                编辑权限
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
        </div>
        
        <!-- 编辑权限对话框 -->
        <el-dialog
            v-model="dialogVisible"
            title="编辑用户权限"
            width="500px"
        >
            <div v-if="editingUser">
                <h4>用户: {{ editingUser.username }}</h4>
                <div class="permission-edit">
                    <el-checkbox-group v-model="selectedPermissions">
                        <el-checkbox 
                            v-for="permission in availablePermissions" 
                            :key="permission" 
                            :label="permission"
                        >
                            {{ permission }}
                        </el-checkbox>
                    </el-checkbox-group>
                </div>
                <div style="margin-top: 20px;">
                    <el-switch 
                        v-model="isAdmin"
                        active-text="管理员"
                        inactive-text="普通用户"
                    ></el-switch>
                </div>
            </div>
            <div class="dialog-footer">
                <el-button @click="dialogVisible = false">取消</el-button>
                <el-button type="primary" @click="saveUserPermissions">保存</el-button>
            </div>
        </el-dialog>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage, ElNotification } = ElementPlus;
        
        createApp({
            data() {
                return {
                    currentUser: null,
                    searchQuery: '',
                    // 模拟用户数据
                    users: [
                        {
                            id: 1,
                            username: 'admin',
                            email: 'admin@example.com',
                            role: 'admin',
                            is_active: true,
                            permissions: ['view_assets', 'edit_assets', 'view_users', 'edit_users', 'view_services', 'edit_services']
                        },
                        {
                            id: 2,
                            username: 'user1',
                            email: 'user1@example.com',
                            role: 'user',
                            is_active: true,
                            permissions: ['view_assets', 'view_services']
                        },
                        {
                            id: 3,
                            username: 'user2',
                            email: 'user2@example.com',
                            role: 'user',
                            is_active: true,
                            permissions: ['view_assets', 'edit_assets']
                        }
                    ],
                    dialogVisible: false,
                    editingUser: null,
                    selectedPermissions: [],
                    isAdmin: false,
                    // 可用权限列表
                    availablePermissions: [
                        'view_assets', 'edit_assets',
                        'view_services', 'edit_services',
                        'view_users', 'edit_users',
                        'view_departments', 'edit_departments'
                    ]
                }
            },
            computed: {
                filteredUsers() {
                    if (!this.searchQuery) {
                        return this.users;
                    }
                    const query = this.searchQuery.toLowerCase();
                    return this.users.filter(user => 
                        user.username.toLowerCase().includes(query) ||
                        user.email.toLowerCase().includes(query)
                    );
                }
            },
            mounted() {
                // 检查用户是否已登录
                this.checkAuth();
                // 获取当前用户信息
                this.getCurrentUserInfo();
                // 应用权限控制
                this.applyPermissions();
            },
            methods: {
                checkAuth() {
                    // 如果使用auth.js中的方法检查认证
                    if (typeof authService !== 'undefined' && !authService.isAuthenticated()) {
                        window.location.href = '/login.html';
                    }
                },
                getCurrentUserInfo() {
                    // 如果使用auth.js中的方法获取用户信息
                    if (typeof authService !== 'undefined') {
                        this.currentUser = authService.getCurrentUser();
                    } else {
                        // 模拟当前用户信息
                        this.currentUser = {
                            username: 'admin',
                            role: 'admin'
                        };
                    }
                },
                handleLogout() {
                    if (typeof authService !== 'undefined') {
                        authService.logout();
                    } else {
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = '/login.html';
                    }
                },
                handleSearch() {
                    // 搜索逻辑已在computed中处理
                    ElMessage({ message: '搜索完成', type: 'info' });
                },
                updateUserStatus(user) {
                    ElMessage({
                        message: `用户${user.username}状态已更新为${user.is_active ? '启用' : '禁用'}`,
                        type: 'success'
                    });
                    // 实际项目中应调用API更新用户状态
                },
                editUserPermissions(user) {
                    this.editingUser = { ...user };
                    this.selectedPermissions = [...user.permissions];
                    this.isAdmin = user.role === 'admin';
                    this.dialogVisible = true;
                },
                saveUserPermissions() {
                    if (this.editingUser) {
                        // 更新用户权限
                        const userIndex = this.users.findIndex(u => u.id === this.editingUser.id);
                        if (userIndex !== -1) {
                            this.users[userIndex].permissions = [...this.selectedPermissions];
                            this.users[userIndex].role = this.isAdmin ? 'admin' : 'user';
                        }
                        
                        ElNotification({
                            title: '成功',
                            message: '用户权限已更新',
                            type: 'success'
                        });
                        
                        this.dialogVisible = false;
                        this.editingUser = null;
                        this.selectedPermissions = [];
                    }
                },
                applyPermissions() {
                    // 简单的权限控制实现
                    // 在实际项目中应使用auth.js中的authUtils.applyPermissions()
                    if (!this.currentUser || this.currentUser.role !== 'admin') {
                        document.querySelectorAll('[data-admin-only]').forEach(element => {
                            element.style.display = 'none';
                        });
                    }
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>