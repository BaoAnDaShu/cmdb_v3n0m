<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户权限管理 - CMDB系统</title>
    <link href="https://cdn.jsdelivr.net/npm/element-plus@2.4.0/dist/index.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus@2.4.0/dist/index.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="auth.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f7fa;
            min-height: 100vh;
        }
        .header {
            background-color: #1989fa;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }
        .header-title {
            font-size: 20px;
            font-weight: 600;
        }
        .user-info {
            display: flex;
            align-items: center;
        }
        .user-name {
            margin-right: 15px;
        }
        .logout-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        .container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .nav-tabs {
            background-color: white;
            padding: 0;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 0;
        }
        .tab-content {
            background-color: white;
            padding: 20px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .page-header {
            padding-bottom: 20px;
            border-bottom: 1px solid #ebeef5;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .page-title {
            font-size: 18px;
            font-weight: 600;
            color: #303133;
            margin: 0;
        }
        .header-actions {
            display: flex;
            gap: 10px;
        }
        .filter-area {
            padding: 20px;
            background-color: #f4f4f5;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .filter-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        .filter-item {
            display: flex;
            align-items: center;
        }
        .filter-label {
            margin-right: 8px;
            white-space: nowrap;
        }
        .data-table {
            margin-bottom: 20px;
        }
        .permission-tree {
            border: 1px solid #ebeef5;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        .role-card {
            border: 1px solid #ebeef5;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .role-card:hover {
            border-color: #409eff;
            box-shadow: 0 2px 12px 0 rgba(64, 158, 255, 0.1);
        }
        .role-card.active {
            border-color: #409eff;
            background-color: #ecf5ff;
        }
        .role-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .role-name {
            font-weight: 600;
            font-size: 16px;
            color: #303133;
        }
        .role-description {
            color: #606266;
            margin-bottom: 12px;
        }
        .role-permissions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .permission-tag {
            background-color: #ecf5ff;
            border-color: #d9ecff;
            color: #409eff;
        }
        .dialog-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 15px 20px;
            border-top: 1px solid #ebeef5;
            margin-top: 20px;
        }
        .permission-section {
            margin-bottom: 16px;
        }
        .permission-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #303133;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 顶部导航 -->
        <div class="header">
            <div class="header-title">CMDB资产管理系统</div>
            <div class="user-info">
                <span class="user-name">欢迎, {{ currentUser?.username }}</span>
                <button class="logout-btn" @click="handleLogout">退出登录</button>
            </div>
        </div>
        
        <!-- 主要内容区域 -->
        <div class="container">
            <!-- 标签页导航 -->
            <div class="nav-tabs">
                <el-tabs v-model="activeTab" type="card">
                    <el-tab-pane label="用户管理" name="users">
                        <div class="tab-content">
                            <!-- 用户管理内容 -->
                            <div class="page-header">
                                <h2 class="page-title">用户列表</h2>
                                <div class="header-actions">
                                    <el-button type="primary" @click="handleAddUser">添加用户</el-button>
                                </div>
                            </div>
                            
                            <div class="filter-area">
                                <div class="filter-form">
                                    <div class="filter-item">
                                        <span class="filter-label">用户名:</span>
                                        <el-input v-model="userFilters.username" placeholder="搜索用户名" style="width: 150px;"></el-input>
                                    </div>
                                    <div class="filter-item">
                                        <span class="filter-label">邮箱:</span>
                                        <el-input v-model="userFilters.email" placeholder="搜索邮箱" style="width: 200px;"></el-input>
                                    </div>
                                    <div class="filter-item">
                                        <span class="filter-label">角色:</span>
                                        <el-select v-model="userFilters.role" placeholder="选择角色" style="width: 120px;">
                                            <el-option label="全部" value=""></el-option>
                                            <el-option label="管理员" value="admin"></el-option>
                                            <el-option label="普通用户" value="user"></el-option>
                                            <el-option label="只读用户" value="viewer"></el-option>
                                        </el-select>
                                    </div>
                                    <div class="filter-item">
                                        <span class="filter-label">状态:</span>
                                        <el-select v-model="userFilters.status" placeholder="选择状态" style="width: 120px;">
                                            <el-option label="全部" value=""></el-option>
                                            <el-option label="启用" value="active"></el-option>
                                            <el-option label="禁用" value="inactive"></el-option>
                                        </el-select>
                                    </div>
                                    <div class="filter-item">
                                        <el-button type="primary" @click="handleUserSearch">搜索</el-button>
                                        <el-button @click="resetUserFilters">重置</el-button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="data-table">
                                <el-table :data="filteredUsers" style="width: 100%">
                                    <el-table-column prop="id" label="用户ID" width="80"></el-table-column>
                                    <el-table-column prop="username" label="用户名" width="150"></el-table-column>
                                    <el-table-column prop="email" label="邮箱" width="200"></el-table-column>
                                    <el-table-column prop="role" label="角色" width="120">
                                        <template #default="scope">
                                            <el-tag :type="getRoleTagType(scope.row.role)">{{ getRoleLabel(scope.row.role) }}</el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="status" label="状态" width="100">
                                        <template #default="scope">
                                            <el-switch
                                                v-model="scope.row.status"
                                                :active-value="'active'"
                                                :inactive-value="'inactive'"
                                                @change="handleUserStatusChange(scope.row)"
                                                active-text="启用"
                                                inactive-text="禁用"
                                            ></el-switch>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="created_at" label="创建时间" width="180"></el-table-column>
                                    <el-table-column label="操作" width="240" fixed="right">
                                        <template #default="scope">
                                            <el-button size="small" @click="viewUserDetails(scope.row)">查看</el-button>
                                            <el-button type="primary" size="small" @click="editUser(scope.row)" data-permission="manage_users">编辑</el-button>
                                            <el-button type="success" size="small" @click="editUserPermissions(scope.row)" data-permission="manage_users">权限</el-button>
                                            <el-button type="danger" size="small" @click="deleteUser(scope.row)" data-permission="manage_users">删除</el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                                
                                <!-- 分页 -->
                                <div style="margin-top: 20px; display: flex; justify-content: flex-end;">
                                    <el-pagination
                                        v-model:current-page="userPagination.currentPage"
                                        v-model:page-size="userPagination.pageSize"
                                        :page-sizes="[10, 20, 50, 100]"
                                        layout="total, sizes, prev, pager, next, jumper"
                                        :total="filteredUsers.length"
                                        @size-change="handleUserSizeChange"
                                        @current-change="handleUserCurrentChange"
                                    ></el-pagination>
                                </div>
                            </div>
                        </div>
                    </el-tab-pane>
                    
                    <el-tab-pane label="角色管理" name="roles">
                        <div class="tab-content">
                            <!-- 角色管理内容 -->
                            <div class="page-header">
                                <h2 class="page-title">角色管理</h2>
                                <div class="header-actions">
                                    <el-button type="primary" @click="handleAddRole">添加角色</el-button>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <!-- 角色列表 -->
                                    <div class="role-list">
                                        <div
                                            v-for="role in roles"
                                            :key="role.id"
                                            :class="['role-card', { active: selectedRole?.id === role.id }]"
                                            @click="selectRole(role)"
                                        >
                                            <div class="role-header">
                                                <span class="role-name">{{ role.name }}</span>
                                                <div>
                                                    <el-button type="text" icon="el-icon-edit" size="small" @click.stop="editRole(role)" data-permission="manage_roles"></el-button>
                                                    <el-button type="text" icon="el-icon-delete" size="small" @click.stop="deleteRole(role)" data-permission="manage_roles"></el-button>
                                                </div>
                                            </div>
                                            <div class="role-description">{{ role.description }}</div>
                                            <div class="role-permissions">
                                                <el-tag 
                                                    v-for="(perm, index) in role.permissions.slice(0, 3)"
                                                    :key="index"
                                                    size="small"
                                                    class="permission-tag"
                                                >
                                                    {{ getPermissionLabel(perm) }}
                                                </el-tag>
                                                <el-tag 
                                                    v-if="role.permissions.length > 3"
                                                    size="small"
                                                    class="permission-tag"
                                                >
                                                    +{{ role.permissions.length - 3 }}
                                                </el-tag>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <!-- 角色权限配置 -->
                                    <div v-if="selectedRole" class="permission-config">
                                        <h3>角色权限配置 - {{ selectedRole.name }}</h3>
                                        <div class="permission-tree">
                                            <el-tree
                                                v-model="selectedRolePermissions"
                                                :data="permissionTree"
                                                show-checkbox
                                                node-key="key"
                                                :default-expand-all="true"
                                                @check="handlePermissionCheck"
                                            >
                                                <template #default="{ node, data }">
                                                    <span class="custom-tree-node">
                                                        <span>{{ node.label }}</span>
                                                        <span v-if="data.description">
                                                            <el-tooltip effect="dark" :content="data.description" placement="right">
                                                                <el-button type="text" size="mini" icon="el-icon-info"></el-button>
                                                            </el-tooltip>
                                                        </span>
                                                    </span>
                                                </template>
                                            </el-tree>
                                        </div>
                                        <div class="dialog-footer">
                                            <el-button @click="resetRolePermissions">重置</el-button>
                                            <el-button type="primary" @click="saveRolePermissions" data-permission="manage_roles">保存权限</el-button>
                                        </div>
                                    </div>
                                    <div v-else class="empty-state">
                                        <div style="text-align: center; padding: 60px 20px; color: #909399;">
                                            <el-icon size="64"><Setting /></el-icon>
                                            <p style="margin-top: 20px;">请选择一个角色来配置权限</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </el-tab-pane>
                    
                    <el-tab-pane label="权限审计" name="audit">
                        <div class="tab-content">
                            <!-- 权限审计内容 -->
                            <div class="page-header">
                                <h2 class="page-title">权限审计日志</h2>
                            </div>
                            
                            <div class="filter-area">
                                <div class="filter-form">
                                    <div class="filter-item">
                                        <span class="filter-label">操作用户:</span>
                                        <el-input v-model="auditFilters.username" placeholder="搜索操作用户" style="width: 150px;"></el-input>
                                    </div>
                                    <div class="filter-item">
                                        <span class="filter-label">操作类型:</span>
                                        <el-select v-model="auditFilters.action_type" placeholder="选择操作类型" style="width: 150px;">
                                            <el-option label="全部" value=""></el-option>
                                            <el-option label="登录" value="login"></el-option>
                                            <el-option label="登出" value="logout"></el-option>
                                            <el-option label="创建" value="create"></el-option>
                                            <el-option label="更新" value="update"></el-option>
                                            <el-option label="删除" value="delete"></el-option>
                                            <el-option label="权限变更" value="permission_change"></el-option>
                                        </el-select>
                                    </div>
                                    <div class="filter-item">
                                        <span class="filter-label">时间范围:</span>
                                        <el-date-picker
                                            v-model="auditFilters.date_range"
                                            type="daterange"
                                            range-separator="至"
                                            start-placeholder="开始日期"
                                            end-placeholder="结束日期"
                                            style="width: 250px;"
                                        ></el-date-picker>
                                    </div>
                                    <div class="filter-item">
                                        <el-button type="primary" @click="handleAuditSearch">搜索</el-button>
                                        <el-button @click="resetAuditFilters">重置</el-button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="data-table">
                                <el-table :data="filteredAuditLogs" style="width: 100%">
                                    <el-table-column prop="id" label="记录ID" width="80"></el-table-column>
                                    <el-table-column prop="username" label="操作用户" width="120"></el-table-column>
                                    <el-table-column prop="action_type" label="操作类型" width="120">
                                        <template #default="scope">
                                            <el-tag :type="getAuditActionTypeTagType(scope.row.action_type)">{{ getAuditActionTypeLabel(scope.row.action_type) }}</el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="resource_type" label="资源类型" width="120"></el-table-column>
                                    <el-table-column prop="resource_id" label="资源ID" width="100"></el-table-column>
                                    <el-table-column prop="details" label="操作详情" min-width="200"></el-table-column>
                                    <el-table-column prop="ip_address" label="IP地址" width="150"></el-table-column>
                                    <el-table-column prop="created_at" label="操作时间" width="180"></el-table-column>
                                </el-table>
                                
                                <!-- 分页 -->
                                <div style="margin-top: 20px; display: flex; justify-content: flex-end;">
                                    <el-pagination
                                        v-model:current-page="auditPagination.currentPage"
                                        v-model:page-size="auditPagination.pageSize"
                                        :page-sizes="[10, 20, 50, 100]"
                                        layout="total, sizes, prev, pager, next, jumper"
                                        :total="filteredAuditLogs.length"
                                        @size-change="handleAuditSizeChange"
                                        @current-change="handleAuditCurrentChange"
                                    ></el-pagination>
                                </div>
                            </div>
                        </div>
                    </el-tab-pane>
                </el-tabs>
            </div>
        </div>
        
        <!-- 添加/编辑用户对话框 -->
        <el-dialog
            v-model="userDialogVisible"
            :title="isEditingUser ? '编辑用户' : '添加用户'"
            width="600px"
        >
            <el-form :model="userForm" :rules="userRules" ref="userFormRef">
                <el-form-item label="用户名" prop="username">
                    <el-input v-model="userForm.username" placeholder="请输入用户名"></el-input>
                </el-form-item>
                <el-form-item label="邮箱" prop="email">
                    <el-input v-model="userForm.email" placeholder="请输入邮箱" type="email"></el-input>
                </el-form-item>
                <el-form-item v-if="!isEditingUser" label="密码" prop="password">
                    <el-input v-model="userForm.password" placeholder="请输入密码" type="password" show-password></el-input>
                </el-form-item>
                <el-form-item label="角色" prop="role">
                    <el-select v-model="userForm.role" placeholder="请选择角色">
                        <el-option label="管理员" value="admin"></el-option>
                        <el-option label="普通用户" value="user"></el-option>
                        <el-option label="只读用户" value="viewer"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="状态" prop="status">
                    <el-radio-group v-model="userForm.status">
                        <el-radio label="active">启用</el-radio>
                        <el-radio label="inactive">禁用</el-radio>
                    </el-radio-group>
                </el-form-item>
            </el-form>
            <div class="dialog-footer">
                <el-button @click="userDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="handleSaveUser">保存</el-button>
            </div>
        </el-dialog>
        
        <!-- 用户权限编辑对话框 -->
        <el-dialog
            v-model="userPermissionsDialogVisible"
            title="用户权限编辑"
            width="800px"
        >
            <div v-if="currentUserForPermissions">
                <h3>{{ currentUserForPermissions.username }} 的权限设置</h3>
                <div class="permission-section">
                    <h4 class="permission-title">用户角色</h4>
                    <el-select v-model="currentUserForPermissions.role" placeholder="选择角色">
                        <el-option label="管理员" value="admin"></el-option>
                        <el-option label="普通用户" value="user"></el-option>
                        <el-option label="只读用户" value="viewer"></el-option>
                    </el-select>
                </div>
                <div class="permission-section">
                    <h4 class="permission-title">自定义权限 (将覆盖角色默认权限)</h4>
                    <div class="permission-tree">
                        <el-tree
                            v-model="customUserPermissions"
                            :data="permissionTree"
                            show-checkbox
                            node-key="key"
                            :default-expand-all="true"
                        >
                            <template #default="{ node, data }">
                                <span class="custom-tree-node">
                                    <span>{{ node.label }}</span>
                                    <span v-if="data.description">
                                        <el-tooltip effect="dark" :content="data.description" placement="right">
                                            <el-button type="text" size="mini" icon="el-icon-info"></el-button>
                                        </el-tooltip>
                                    </span>
                                </span>
                            </template>
                        </el-tree>
                    </div>
                </div>
            </div>
            <div class="dialog-footer">
                <el-button @click="userPermissionsDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="saveUserPermissions">保存权限</el-button>
            </div>
        </el-dialog>
        
        <!-- 添加/编辑角色对话框 -->
        <el-dialog
            v-model="roleDialogVisible"
            :title="isEditingRole ? '编辑角色' : '添加角色'"
            width="600px"
        >
            <el-form :model="roleForm" :rules="roleRules" ref="roleFormRef">
                <el-form-item label="角色名称" prop="name">
                    <el-input v-model="roleForm.name" placeholder="请输入角色名称"></el-input>
                </el-form-item>
                <el-form-item label="角色描述" prop="description">
                    <el-input v-model="roleForm.description" type="textarea" placeholder="请输入角色描述"></el-input>
                </el-form-item>
            </el-form>
            <div class="dialog-footer">
                <el-button @click="roleDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="handleSaveRole">保存</el-button>
            </div>
        </el-dialog>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage, ElNotification, ElMessageBox } = ElementPlus;
        
        createApp({
            data() {
                return {
                    currentUser: null,
                    activeTab: 'users',
                    
                    // 用户相关
                    users: [
                        { id: 1, username: 'admin', email: 'admin@example.com', role: 'admin', status: 'active', created_at: '2024-01-01 10:00:00', permissions: ['view_assets', 'edit_assets', 'manage_users', 'manage_roles'] },
                        { id: 2, username: 'user1', email: 'user1@example.com', role: 'user', status: 'active', created_at: '2024-01-02 14:30:00', permissions: ['view_assets', 'edit_assets'] },
                        { id: 3, username: 'viewer1', email: 'viewer1@example.com', role: 'viewer', status: 'active', created_at: '2024-01-03 09:15:00', permissions: ['view_assets'] },
                        { id: 4, username: 'user2', email: 'user2@example.com', role: 'user', status: 'inactive', created_at: '2024-01-04 16:45:00', permissions: ['view_assets', 'edit_assets'] }
                    ],
                    userFilters: {
                        username: '',
                        email: '',
                        role: '',
                        status: ''
                    },
                    userPagination: {
                        currentPage: 1,
                        pageSize: 10
                    },
                    userDialogVisible: false,
                    userPermissionsDialogVisible: false,
                    isEditingUser: false,
                    currentUserForDetails: null,
                    currentUserForPermissions: null,
                    userForm: {
                        username: '',
                        email: '',
                        password: '',
                        role: 'user',
                        status: 'active'
                    },
                    userRules: {
                        username: [{ required: true, message: '请输入用户名', trigger: 'blur' }],
                        email: [{ required: true, message: '请输入邮箱', trigger: 'blur' }, { type: 'email', message: '邮箱格式不正确', trigger: 'blur' }],
                        password: [{ required: true, message: '请输入密码', trigger: 'blur' }],
                        role: [{ required: true, message: '请选择角色', trigger: 'change' }],
                        status: [{ required: true, message: '请选择状态', trigger: 'change' }]
                    },
                    customUserPermissions: [],
                    
                    // 角色相关
                    roles: [
                        { id: 1, name: '管理员', description: '系统管理员，拥有所有权限', permissions: ['view_assets', 'edit_assets', 'manage_users', 'manage_roles'] },
                        { id: 2, name: '普通用户', description: '普通操作权限，可以查看和编辑资产', permissions: ['view_assets', 'edit_assets'] },
                        { id: 3, name: '只读用户', description: '只读权限，只能查看资产信息', permissions: ['view_assets'] }
                    ],
                    selectedRole: null,
                    selectedRolePermissions: [],
                    roleDialogVisible: false,
                    isEditingRole: false,
                    roleForm: {
                        name: '',
                        description: ''
                    },
                    roleRules: {
                        name: [{ required: true, message: '请输入角色名称', trigger: 'blur' }],
                        description: [{ required: true, message: '请输入角色描述', trigger: 'blur' }]
                    },
                    
                    // 权限树结构
                    permissionTree: [
                        {
                            label: '资产管理',
                            key: 'assets',
                            description: '资产相关权限',
                            children: [
                                {
                                    label: '查看资产',
                                    key: 'view_assets',
                                    description: '查看资产信息的权限'
                                },
                                {
                                    label: '编辑资产',
                                    key: 'edit_assets',
                                    description: '添加、编辑、删除资产的权限'
                                },
                                {
                                    label: '导出资产',
                                    key: 'export_assets',
                                    description: '导出资产数据的权限'
                                },
                                {
                                    label: '导入资产',
                                    key: 'import_assets',
                                    description: '导入资产数据的权限'
                                }
                            ]
                        },
                        {
                            label: '用户管理',
                            key: 'users',
                            description: '用户相关权限',
                            children: [
                                {
                                    label: '查看用户',
                                    key: 'view_users',
                                    description: '查看用户信息的权限'
                                },
                                {
                                    label: '管理用户',
                                    key: 'manage_users',
                                    description: '添加、编辑、删除用户的权限'
                                }
                            ]
                        },
                        {
                            label: '角色管理',
                            key: 'roles',
                            description: '角色相关权限',
                            children: [
                                {
                                    label: '查看角色',
                                    key: 'view_roles',
                                    description: '查看角色信息的权限'
                                },
                                {
                                    label: '管理角色',
                                    key: 'manage_roles',
                                    description: '添加、编辑、删除角色和配置权限的权限'
                                }
                            ]
                        },
                        {
                            label: '系统设置',
                            key: 'settings',
                            description: '系统设置相关权限',
                            children: [
                                {
                                    label: '查看系统日志',
                                    key: 'view_system_logs',
                                    description: '查看系统操作日志的权限'
                                },
                                {
                                    label: '管理系统配置',
                                    key: 'manage_system_settings',
                                    description: '修改系统配置的权限'
                                }
                            ]
                        }
                    ],
                    
                    // 审计日志相关
                    auditLogs: [
                        { id: 1, username: 'admin', action_type: 'login', resource_type: 'user', resource_id: '1', details: '用户登录成功', ip_address: '192.168.1.100', created_at: '2024-01-15 10:15:30' },
                        { id: 2, username: 'admin', action_type: 'create', resource_type: 'asset', resource_id: '5', details: '创建新资产: 测试服务器01', ip_address: '192.168.1.100', created_at: '2024-01-15 10:20:45' },
                        { id: 3, username: 'user1', action_type: 'update', resource_type: 'asset', resource_id: '3', details: '更新资产状态: 维护中 -> 使用中', ip_address: '192.168.1.101', created_at: '2024-01-15 11:05:20' },
                        { id: 4, username: 'admin', action_type: 'permission_change', resource_type: 'role', resource_id: '2', details: '更新角色权限: 添加查看用户权限', ip_address: '192.168.1.100', created_at: '2024-01-15 14:30:10' },
                        { id: 5, username: 'admin', action_type: 'logout', resource_type: 'user', resource_id: '1', details: '用户退出登录', ip_address: '192.168.1.100', created_at: '2024-01-15 17:45:55' }
                    ],
                    auditFilters: {
                        username: '',
                        action_type: '',
                        date_range: null
                    },
                    auditPagination: {
                        currentPage: 1,
                        pageSize: 10
                    }
                }
            },
            computed: {
                // 用户过滤计算
                filteredUsers() {
                    let result = [...this.users];
                    
                    if (this.userFilters.username) {
                        result = result.filter(item => 
                            item.username.toLowerCase().includes(this.userFilters.username.toLowerCase())
                        );
                    }
                    if (this.userFilters.email) {
                        result = result.filter(item => 
                            item.email.toLowerCase().includes(this.userFilters.email.toLowerCase())
                        );
                    }
                    if (this.userFilters.role) {
                        result = result.filter(item => item.role === this.userFilters.role);
                    }
                    if (this.userFilters.status) {
                        result = result.filter(item => item.status === this.userFilters.status);
                    }
                    
                    return result;
                },
                
                // 审计日志过滤计算
                filteredAuditLogs() {
                    let result = [...this.auditLogs];
                    
                    if (this.auditFilters.username) {
                        result = result.filter(item => 
                            item.username.toLowerCase().includes(this.auditFilters.username.toLowerCase())
                        );
                    }
                    if (this.auditFilters.action_type) {
                        result = result.filter(item => item.action_type === this.auditFilters.action_type);
                    }
                    if (this.auditFilters.date_range && this.auditFilters.date_range.length === 2) {
                        result = result.filter(item => {
                            const logDate = new Date(item.created_at.split(' ')[0]);
                            const startDate = new Date(this.auditFilters.date_range[0]);
                            const endDate = new Date(this.auditFilters.date_range[1]);
                            return logDate >= startDate && logDate <= endDate;
                        });
                    }
                    
                    return result;
                }
            },
            mounted() {
                // 检查用户认证
                this.checkAuth();
                // 获取当前用户信息
                this.getCurrentUserInfo();
                // 应用权限控制
                this.applyPermissions();
            },
            methods: {
                checkAuth() {
                    // 检查用户是否已登录
                    if (typeof authService !== 'undefined' && !authService.isAuthenticated()) {
                        window.location.href = '/login.html';
                    }
                },
                getCurrentUserInfo() {
                    // 获取当前用户信息
                    if (typeof authService !== 'undefined') {
                        this.currentUser = authService.getCurrentUser();
                    } else {
                        // 模拟当前用户信息
                        this.currentUser = {
                            username: 'admin',
                            role: 'admin',
                            permissions: ['view_assets', 'edit_assets', 'manage_users', 'manage_roles']
                        };
                    }
                },
                handleLogout() {
                    // 处理退出登录
                    if (typeof authService !== 'undefined') {
                        authService.logout();
                    } else {
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = '/login.html';
                    }
                },
                applyPermissions() {
                    // 简单的权限控制实现
                    // 在实际项目中应使用auth.js中的authUtils.applyPermissions()
                    if (typeof authService !== 'undefined') {
                        document.querySelectorAll('[data-permission]').forEach(element => {
                            const requiredPerm = element.getAttribute('data-permission');
                            if (!authService.hasPermission(requiredPerm)) {
                                element.style.display = 'none';
                            }
                        });
                    } else if (this.currentUser && this.currentUser.role !== 'admin') {
                        // 模拟权限控制
                        document.querySelectorAll('[data-permission]').forEach(element => {
                            element.style.display = 'none';
                        });
                    }
                },
                
                // 用户管理相关方法
                handleUserSearch() {
                    // 重置分页
                    this.userPagination.currentPage = 1;
                    ElMessage({ message: '筛选条件已应用', type: 'success' });
                },
                resetUserFilters() {
                    // 重置筛选条件
                    this.userFilters = {
                        username: '',
                        email: '',
                        role: '',
                        status: ''
                    };
                    this.userPagination.currentPage = 1;
                },
                handleUserSizeChange(size) {
                    this.userPagination.pageSize = size;
                },
                handleUserCurrentChange(current) {
                    this.userPagination.currentPage = current;
                },
                handleAddUser() {
                    // 重置表单
                    this.userForm = {
                        username: '',
                        email: '',
                        password: '',
                        role: 'user',
                        status: 'active'
                    };
                    this.isEditingUser = false;
                    this.userDialogVisible = true;
                },
                editUser(user) {
                    // 编辑用户
                    this.userForm = { ...user };
                    this.isEditingUser = true;
                    this.userDialogVisible = true;
                },
                viewUserDetails(user) {
                    // 查看用户详情
                    this.currentUserForDetails = { ...user };
                    // 可以实现详情对话框
                    ElMessageBox.alert(
                        `用户ID: ${user.id}<br>` +
                        `用户名: ${user.username}<br>` +
                        `邮箱: ${user.email}<br>` +
                        `角色: ${this.getRoleLabel(user.role)}<br>` +
                        `状态: ${user.status === 'active' ? '启用' : '禁用'}<br>` +
                        `创建时间: ${user.created_at}<br>` +
                        `权限: ${user.permissions ? user.permissions.join(', ') : '无特殊权限'}`,
                        '用户详情',
                        {
                            dangerouslyUseHTMLString: true
                        }
                    );
                },
                editUserPermissions(user) {
                    // 编辑用户权限
                    this.currentUserForPermissions = { ...user };
                    this.customUserPermissions = user.permissions || [];
                    this.userPermissionsDialogVisible = true;
                },
                async handleSaveUser() {
                    // 验证表单
                    const formRef = this.$refs.userFormRef;
                    if (formRef) {
                        formRef.validate(async (valid) => {
                            if (valid) {
                                try {
                                    if (this.isEditingUser) {
                                        // 更新用户
                                        const index = this.users.findIndex(item => item.id === this.userForm.id);
                                        if (index !== -1) {
                                            // 不更新密码字段
                                            const updateData = { ...this.userForm };
                                            if (!updateData.password) {
                                                delete updateData.password;
                                            }
                                            this.users[index] = updateData;
                                            ElNotification({
                                                title: '成功',
                                                message: '用户已更新',
                                                type: 'success'
                                            });
                                        }
                                    } else {
                                        // 添加新用户
                                        const newUser = {
                                            ...this.userForm,
                                            id: Date.now(), // 临时ID，实际应从后端获取
                                            created_at: new Date().toLocaleString('zh-CN'),
                                            permissions: []
                                        };
                                        this.users.unshift(newUser);
                                        ElNotification({
                                            title: '成功',
                                            message: '用户已添加',
                                            type: 'success'
                                        });
                                    }
                                    this.userDialogVisible = false;
                                } catch (error) {
                                    ElMessage.error('保存失败: ' + (error.message || '未知错误'));
                                }
                            }
                        });
                    }
                },
                handleUserStatusChange(user) {
                    // 处理用户状态变更
                    ElMessage({
                        message: `用户${user.username}状态已更新为${user.status === 'active' ? '启用' : '禁用'}`,
                        type: 'success'
                    });
                },
                saveUserPermissions() {
                    // 保存用户权限
                    if (this.currentUserForPermissions) {
                        const index = this.users.findIndex(item => item.id === this.currentUserForPermissions.id);
                        if (index !== -1) {
                            this.users[index].role = this.currentUserForPermissions.role;
                            this.users[index].permissions = [...this.customUserPermissions];
                            ElNotification({
                                title: '成功',
                                message: '用户权限已更新',
                                type: 'success'
                            });
                        }
                    }
                    this.userPermissionsDialogVisible = false;
                },
                async deleteUser(user) {
                    // 删除用户
                    ElMessageBox.confirm(
                        `确定要删除用户「${user.username}」吗？`,
                        '删除确认',
                        {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }
                    ).then(async () => {
                        try {
                            const index = this.users.findIndex(item => item.id === user.id);
                            if (index !== -1) {
                                this.users.splice(index, 1);
                                ElNotification({
                                    title: '成功',
                                    message: '用户已删除',
                                    type: 'success'
                                });
                            }
                        } catch (error) {
                            ElMessage.error('删除失败: ' + (error.message || '未知错误'));
                        }
                    }).catch(() => {
                        // 用户取消删除
                    });
                },
                
                // 角色管理相关方法
                selectRole(role) {
                    // 选择角色
                    this.selectedRole = { ...role };
                    this.selectedRolePermissions = [...role.permissions];
                },
                handleAddRole() {
                    // 添加角色
                    this.roleForm = {
                        name: '',
                        description: ''
                    };
                    this.isEditingRole = false;
                    this.roleDialogVisible = true;
                },
                editRole(role) {
                    // 编辑角色
                    this.roleForm = { ...role };
                    this.isEditingRole = true;
                    this.roleDialogVisible = true;
                },
                async handleSaveRole() {
                    // 验证表单
                    const formRef = this.$refs.roleFormRef;
                    if (formRef) {
                        formRef.validate(async (valid) => {
                            if (valid) {
                                try {
                                    if (this.isEditingRole) {
                                        // 更新角色
                                        const index = this.roles.findIndex(item => item.id === this.roleForm.id);
                                        if (index !== -1) {
                                            this.roles[index] = {
                                                ...this.roleForm,
                                                permissions: this.roles[index].permissions
                                            };
                                            // 如果当前选中的是这个角色，更新选中状态
                                            if (this.selectedRole && this.selectedRole.id === this.roleForm.id) {
                                                this.selectedRole = { ...this.roles[index] };
                                            }
                                            ElNotification({
                                                title: '成功',
                                                message: '角色已更新',
                                                type: 'success'
                                            });
                                        }
                                    } else {
                                        // 添加新角色
                                        const newRole = {
                                            ...this.roleForm,
                                            id: Date.now(), // 临时ID，实际应从后端获取
                                            permissions: []
                                        };
                                        this.roles.push(newRole);
                                        ElNotification({
                                            title: '成功',
                                            message: '角色已添加',
                                            type: 'success'
                                        });
                                    }
                                    this.roleDialogVisible = false;
                                } catch (error) {
                                    ElMessage.error('保存失败: ' + (error.message || '未知错误'));
                                }
                            }
                        });
                    }
                },
                async deleteRole(role) {
                    // 删除角色
                    ElMessageBox.confirm(
                        `确定要删除角色「${role.name}」吗？`,
                        '删除确认',
                        {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }
                    ).then(async () => {
                        try {
                            const index = this.roles.findIndex(item => item.id === role.id);
                            if (index !== -1) {
                                this.roles.splice(index, 1);
                                // 如果删除的是当前选中的角色，清除选中状态
                                if (this.selectedRole && this.selectedRole.id === role.id) {
                                    this.selectedRole = null;
                                    this.selectedRolePermissions = [];
                                }
                                ElNotification({
                                    title: '成功',
                                    message: '角色已删除',
                                    type: 'success'
                                });
                            }
                        } catch (error) {
                            ElMessage.error('删除失败: ' + (error.message || '未知错误'));
                        }
                    }).catch(() => {
                        // 用户取消删除
                    });
                },
                handlePermissionCheck() {
                    // 权限变更处理
                    // 可以在这里添加权限变更日志记录
                },
                resetRolePermissions() {
                    // 重置角色权限
                    if (this.selectedRole) {
                        this.selectedRolePermissions = [...this.selectedRole.permissions];
                    }
                },
                saveRolePermissions() {
                    // 保存角色权限
                    if (this.selectedRole) {
                        const index = this.roles.findIndex(item => item.id === this.selectedRole.id);
                        if (index !== -1) {
                            this.roles[index].permissions = [...this.selectedRolePermissions];
                            this.selectedRole = { ...this.roles[index] };
                            ElNotification({
                                title: '成功',
                                message: '角色权限已更新',
                                type: 'success'
                            });
                        }
                    }
                },
                
                // 审计日志相关方法
                handleAuditSearch() {
                    // 重置分页
                    this.auditPagination.currentPage = 1;
                    ElMessage({ message: '筛选条件已应用', type: 'success' });
                },
                resetAuditFilters() {
                    // 重置筛选条件
                    this.auditFilters = {
                        username: '',
                        action_type: '',
                        date_range: null
                    };
                    this.auditPagination.currentPage = 1;
                },
                handleAuditSizeChange(size) {
                    this.auditPagination.pageSize = size;
                },
                handleAuditCurrentChange(current) {
                    this.auditPagination.currentPage = current;
                },
                
                // 辅助方法
                getRoleLabel(role) {
                    const roleMap = {
                        'admin': '管理员',
                        'user': '普通用户',
                        'viewer': '只读用户'
                    };
                    return roleMap[role] || role;
                },
                getRoleTagType(role) {
                    const roleMap = {
                        'admin': 'danger',
                        'user': 'primary',
                        'viewer': 'info'
                    };
                    return roleMap[role] || 'info';
                },
                getPermissionLabel(permission) {
                    const permMap = {
                        'view_assets': '查看资产',
                        'edit_assets': '编辑资产',
                        'export_assets': '导出资产',
                        'import_assets': '导入资产',
                        'view_users': '查看用户',
                        'manage_users': '管理用户',
                        'view_roles': '查看角色',
                        'manage_roles': '管理角色',
                        'view_system_logs': '查看系统日志',
                        'manage_system_settings': '管理系统设置'
                    };
                    return permMap[permission] || permission;
                },
                getAuditActionTypeLabel(type) {
                    const typeMap = {
                        'login': '登录',
                        'logout': '登出',
                        'create': '创建',
                        'update': '更新',
                        'delete': '删除',
                        'permission_change': '权限变更'
                    };
                    return typeMap[type] || type;
                },
                getAuditActionTypeTagType(type) {
                    const typeMap = {
                        'login': 'success',
                        'logout': 'info',
                        'create': 'primary',
                        'update': 'warning',
                        'delete': 'danger',
                        'permission_change': 'success'
                    };
                    return typeMap[type] || 'info';
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>